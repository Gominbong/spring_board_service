<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: head}"/>
<div th:replace="~{fragments/header :: header ('home')}"/>

<div class="container" th:object="${musicList}" style="height: 1000px; margin-top: 20px;">

    <ul style="font-size: large">
        <li>제목 <p th:text="*{title}"></p></li>
        <li>만든이 <p th:text="*{memberNickname}"></p></li>
        <li>가격 <p th:text="*{price}"></p></li>
        <li>판매량 <p th:text="*{salesQuantity}"></p></li>
        <li>등록일 <p th:text="*{localDateTime}"></p></li>
        <li>내용 <p style="white-space: pre-line" th:text="*{content}"></p></li>
        <li th:if="${sellBuyList!=null}">구매일<p th:text="${sellBuyList.localDate}"></p></li>
        <li>첨부파일
            <div style="max-height: 150px; overflow: auto">
                <table th:if="${sellBuyList} or ${#strings.equals(loginId,musicList.loginId)}">
                    <tr th:each="fileLists : ${fileList}">
                        <td>
                            <p style="color: blue; text-decoration: underline;  cursor: pointer;"
                               th:text="${fileLists.originalFilename}"
                               th:onclick="download([[${fileLists.id}]])"></p>
                        </td>
                    </tr>
                </table>
            </div>

        </li>
    </ul>

    <div th:if="${sellBuyList==null} and ${!#strings.equals(loginId,musicList.loginId)}">
        <button onclick="buyBtnClick()"
                type="button" class="btn btn-primary btn-lg">구매하기
        </button>
        <button onclick="cartBtnClick()"
                type="button" class="btn btn-primary btn-lg">장바구니
        </button>
    </div>

    <div th:if="${sellBuyList!=null}">
        <button type="button" class="btn btn-primary btn-lg">구매한상품입니다</button>
    </div>

    <div th:if="${#strings.equals(loginId,musicList.loginId)}">
        <button onclick="updateBtnClick()"
                type="button" class="btn btn-primary btn-lg">수정하기
        </button>
        <button onclick="deleteBtnClick()"
                type="button" class="btn btn-primary btn-lg">삭제하기
        </button>
    </div>

    <div id='buy_div' style="display: none">
        <form style="margin-top: 20px">
            <h1>구매하시겠습니까</h1>
            <button type="button" class="btn btn-lg btn-primary"
                    onclick="btnBuy()">Yes
            </button>
        </form>
    </div>

    <div id='cart_div' style="display: none">
        <form style="margin-top: 20px">
            <h1>장바구니담으시겟습니까</h1>
            <button type="button" class="btn btn-lg btn-primary">Yes</button>
        </form>
    </div>

    <div id='update_div' style="display: none">
        <form style="margin-top: 20px" method="post" th:action="@{/editMusicList}">
            <h1>수정하시겠습니까</h1>
            <button type="submit" th:name="musicListId" th:value="${musicList.id}"
                    class="btn btn-lg btn-primary">Yes
            </button>
        </form>
    </div>

    <div id='delete_div' style="display: none">
        <form style="margin-top: 20px" id="delete_form" method="post"
              th:action="@{/deleteMusicList}" onsubmit="return deleteSubmit()">
            <h1>삭제하시겟습니까</h1>
            <button type="submit" th:name="musicListId" th:value="${musicList.id}" class="btn btn-lg btn-primary">Yes
            </button>
        </form>
    </div>


    <div style="margin-top: 20px">
        <button class="btn btn-lg btn-primary" th:text="${'추천 '+ musicList.likeCount}"
                onclick="btnLike()"></button>
    </div>

    <script type="text/javascript">

        function download(fileListId){
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '/download';
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'fileListId'
            input.value = fileListId;
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
        }

        function btnLike() {
            const memberCash = [[${memberCash}]];
            const likeCount = [[${likeCount}]];
            const musicListId = [[${musicList.Id}]];
            if (memberCash == -1) {
                if (confirm("추천하려면로그인하세요")) {
                    document.location.href = "/login";
                }
            } else if (likeCount == 1) {
                alert('아이디당1개추천만가능합니다')
            } else {
                const form = document.createElement('form');
                form.method = 'post';
                form.action = '/likeCount';
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'musicListId'
                input.value = musicListId;
                form.appendChild(input);
                document.body.appendChild(form);
                form.submit();
            }
        }

        function deleteSubmit() {
            if (confirm("삭제하시겠습니까")) {
                return true;
            } else {
                return false;
            }
        }

        function btnBuy() {
            const musicListId = [[${musicList.Id}]];
            const memberCash = [[${memberCash}]];
            const musicPrice = [[${musicList.price}]];
            if (memberCash == -1) {
                if (confirm("구매하시려면로그인하시겠습니까")) {
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/buyMusicList';
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'musicListId'
                    input.value = musicListId;
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                } else {
                    return false;
                }
            } else if (memberCash >= musicPrice) {
                if (confirm("정말구매하시겠습니까")) {
                    const form = document.createElement('form');
                    form.method = 'post';
                    form.action = '/buyMusicList';
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'musicListId'
                    input.value = musicListId;
                    form.appendChild(input);
                    document.body.appendChild(form);
                    form.submit();
                } else {
                    return false;
                }
            } else if (memberCash < musicPrice) {
                if (confirm("잔액이부족합니다충전하시겠습니까")) {
                    document.location.href = "/myInfo";
                } else {
                    return false;
                }
            }
        }

        function buyBtnClick() {
            const buyDiv = document.getElementById('buy_div');
            const cartDiv = document.getElementById('cart_div');
            if (buyDiv.style.display === 'none') {
                cartDiv.style.display = 'none';
                buyDiv.style.display = 'inline';
            }
        }

        function cartBtnClick() {
            const buyDiv = document.getElementById('buy_div');
            const cartDiv = document.getElementById('cart_div');
            if (cartDiv.style.display === 'none') {
                buyDiv.style.display = 'none';
                cartDiv.style.display = 'inline';
            }
        }

        function updateBtnClick() {
            const updateDiv = document.getElementById('update_div');
            const delete_div = document.getElementById('delete_div');
            if (updateDiv.style.display === 'none') {
                delete_div.style.display = 'none';
                updateDiv.style.display = 'inline';
            }
        }

        function deleteBtnClick() {
            const updateDiv = document.getElementById('update_div');
            const delete_div = document.getElementById('delete_div');
            if (delete_div.style.display === 'none') {
                updateDiv.style.display = 'none';
                delete_div.style.display = 'inline';
            }
        }

    </script>
</div>
<div th:replace="~{fragments/footer :: footer}"/>

</html>